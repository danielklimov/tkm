Orders
========================

The diagram represents the process of applicant's 'ordering' Takamol verification services,
paying for them, and receiving the invoice.


Diagram
------------

![orders diagram](img/orders.png)


Description
-------------

A new entity - "Applicant's order" has been added
to unify ordering and payments for two separate document flows - QVP verification requests and SVP bookings.
The order is:

1. a replacement for `payment_checkout` table in QVP.
2. an extension to `verification_requests` and `svp_bookings`, adding
   common behavior to both of these tables and describing the ordering process in standardized terms.

The data model for orders follows the same design pattern as orders/invoices are usually modelled in
online businesses.

The order entity consists of two tables:

- the main table (header) - [applicant_orders](#applicant_orders)
- order items or 'lines' - [applicant_order_items](#applicant_order_items).

An order usually consist of only one line - "Qualification verification request" or
"Skill verification exam". But additional items (lines) may be added, for example, "Additional fee".

An order item references another new table - [verification_services](#verification_services.md).
This table acts as a 'product catalogue' of products and services offered by Takamol and will contain only 3 records:

1. Qualification verification request
2. Skill verification exam
3. Additional fee for qualification verification

with possibility to add more services in future.

The order is created from [verification_requests](../tables/verification_requests.md)
or [svp_bookings](../tables/svp_bookings.md) and it references one of these
documents as the 'parent' document. There are two fields for that:

- parent_document_type - one of VERIFICATION_REQUEST, SVP_BOOKING
- parent_document_id - uuid referencing either `verification_requests` or `svp_bookings`.

The [payments](../tables/payments.md) is a universal payment for QVP and SVP.
The payment is created from an order and references the order as the 'parent' entity.
The payment doesn't 'know' which initial request created the order it is paying for.

The [invoices](../tables/invoices.md) table is also universal for QVP and SVP. The invoice is created from payment
and references the payment as it's 'parent' document.
The invoice has almost the same structure as the Order with a separate [invoice_items](../tables/invoice_items.md) table.



Tables
-----------



### applicant_orders ###

NO | NAME | DATA TYPE | PK | FK | DESCRIPTION            
---|------|-----------|----|----|-------------
1|`id` | uuid | V |  | Autogenerated
2|`order_date` | timestamp |  |  | Date, when the order was created (generated)
3|`applicant_id` | uuid |  | [`applicants`](../tables/applicants.md) | Applicant that created the order
4|`parent_document_type` | varchar |  |  | Parent document type. Enum. One of: VERIFICATION_REQUEST, SVP_BOOKING
5|`parent_document_id` | uuid |  |  | Id of the request that created this order. A reference to: verification_requests or svp_bookings, depending on parent_document_type
6|`currency_code` | varchar |  |  | Order currency. Default USD
7|`total_amount` | numeric(18,2) |  |  | Total order amount including tax
8|`total_tax_amount` | numeric(18,2) |  |  | Total tax (VAT) amount
9|`description` |  |  |  | Usualy contains a string 'successfully created checkout'
10|`created_at` | timestamp |  |  | System field - date and time when the record was created
11|`updated_at` | timestamp |  |  | System field - date and time when the record was modified (or created when the record is new)
12|`deleted_status` | varchar |  |  | ACTIVE, DELETED

### applicant_order_items ###

NO | NAME | DATA TYPE | PK | FK | DESCRIPTION            
---|------|-----------|----|----|-------------
1|`id` | uuid | V |  | Autogenerated
2|`applicant_order_id` | uuid |  | [`applicant_orders`](../tables/applicant_orders.md) | Date, when the order was created (generated)
3|`seq_no` | integer |  |  | Line number within one order
4|`verification_service_id` | uuid |  | [`verification_services`](../tables/verification_services.md) | Product that is included in the order, e.g. Verification fee, Additional fee, Test fee
5|`price` | numeric(18,2) |  |  | price of the service
6|`quantity` | integer |  |  | quantity of services, default 1
7|`amount` | numeric(18,2) |  |  | Item amount in order currency (default USD)
8|`tax_amount` | numeric(18,2) |  |  | Tax (VAT) amount
9|`created_at` | timestamp |  |  | System field - date and time when the record was created
10|`updated_at` | timestamp |  |  | System field - date and time when the record was modified (or created when the record is new)
11|`deleted_status` | varchar |  |  | ACTIVE, DELETED


### verification_services ###  

NO | NAME | DATA TYPE | PK | FK | DESCRIPTION            
---|------|-----------|----|----|-------------
1|`id` | uuid | V |  | Automatically generated surrogate key.
2|`code` | varchar(40) |  |  | Human-readable code used to refer to this record.
3|`name_en` | varchar(200) |  |  | Name in English that will be printed on invoice, e.g. Verification fee, Additional fee, Test fee
4|`name_ar` | varchar(200) |  |  | Name in Arabic that will be printed on invoice, e.g. Verification fee, Additional fee, Test fee
5|`price` | numeric(18,2) |  |  | Price in USD per one unit/one service.
6|`description` | varchar(500) |  |  | Long description (English or Arabic) for technical use.
7|`created_at` | timestamp |  |  | 
8|`updated_at` | timestamp |  |  | 
9|`deleted_status` | varchar(20) |  |  | ACTIVE, DELETED

### payments ###

NO | NAME | DATA TYPE | PK | FK | DESCRIPTION            
---|------|-----------|----|----|-------------
1|`id` | uuid | V |  | autogenerated
2|`applicant_order_id` | uuid |  | [`applicant_orders`](../tables/applicant_orders.md) | Parent applicant order
3|`total_amount` | numeric(18,2) |  |  | Payment amount
4|`hyperpay_id` | varchar |  |  | The id of entity on HyperPay when we make a checkout (create an payment enity on HyperPay side)
5|`hyperpay_response` | jsonb |  |  | JSON - response from payment system
6|`transaction_date` | timestamp |  |  | Date and time of transaction
7|`transaction_last_4_digits` | varchar |  |  | Just last for 4 digits of payment card used for payment returned by HypePay
8|`transaction_payment_brand` | varchar |  |  | One of: null, "visa", "master", "mada", "meeza". Not enum
9|`transaction_status` | integer |  |  | Enum. Possible values (one of):  PREPARED_CHECKOUT, SUCCESS, FAILED, PENDING.
10|`merchant_transaction_id` | varchar |  |  | Merchant transaction id is a transaction id that is assigned by the payment system to the merchant, that is - Takamol
11|`user_id` | uuid |  | [`users`](../tables/users.md) | A reference to user who did the payment
12|`created_at` | timestamp |  |  | 
13|`updated_at` | timestamp |  |  | 
14|`deleted_status` | varchar |  |  | ACTIVE, DELETED

### invoices ###

NO | NAME | DATA TYPE | PK | FK | DESCRIPTION            
---|------|-----------|----|----|-------------
1|`id` | uuid | V |  | autogen
2|`payment_id` | uuid |  | [`payments`](../tables/payments.md) | Parent payment transaction that this invoice was paid with
3|`file_id` | varchar |  | [`file_storage`](../tables/file_storage.md) | A reference to the printable copy of the invoice (pdf)
4|`document_number` | varchar(40) |  |  | A human-readable invoice number.
5|`currency_code` | varchar |  |  | Currency of the amount field (3-letter currency code)
6|`total_amount` | numeric(18,2) |  |  | Invoice amount
7|`total_tax_amount` | numeric(18,2) |  |  | Total VAT included into 'amount'
8|`buyer_name` | varchar |  |  | Name of the buyer (candidate)
9|`qr_code` | text |  |  | TODO: what does this QR code contain? How it is encoded?
10|`supplier_tax_id` | varchar |  |  | Supplier's (Takamol) tax number.
11|`supplier_name` | varchar |  |  | Supplier legal name
12|`supplier_street` | varchar |  |  | Supplier address - street name
13|`supplier_location` | varchar |  |  | Supplier address - Zipcode and country name
14|`currency_convert_ratio` | numeric(18,4) |  |  | TODO: check if it's enough precision. Convertion rate from USD to SAR that is used with this invoice for accounting purposes
15|`zatca_report` | text |  |  | ZATCa is a saudi-national e-invoicing system, all invoices are generated through ZATCA. this XML is a klind of a digitally signed elevation file for the invoice. We need to migrate it
16|`created_at` | timestamp |  |  | 
17|`updated_at` | timestamp |  |  | 
18|`deleted_status` | varchar |  |  | ACTIVE, DELETED

### invoice_items ###

NO | NAME | DATA TYPE | PK | FK | DESCRIPTION            
---|------|-----------|----|----|-------------
1|`id` | uuid | V |  | Autogenerated
2|`invoice_id` | uuid |  | [`invoices`](../tables/invoices.md) | Date, when the order was created (generated)
3|`seq_no` | integer |  |  | Line number within one order
4|`verification_service_id` | uuid |  | [`verification_services`](../tables/verification_services.md) | Product that is included in the invoice, e.g. Verification fee, Additional fee, Test fee
5|`price` | numeric(18,2) |  |  | price of the service
6|`quantity` | integer |  |  | quantity of services, default 1
7|`amount` | numeric(18,2) |  |  | Item amount in order currency (default USD)
8|`tax_amount` | numeric(18,2) |  |  | Tax (VAT) amount
9|`created_at` | timestamp |  |  | System field - date and time when the record was created
10|`updated_at` | timestamp |  |  | System field - date and time when the record was modified (or created when the record is new)
11|`deleted_status` | varchar |  |  | ACTIVE, DELETED

### verification_requests ###

NO | NAME | DATA TYPE | PK | FK | DESCRIPTION            
---|------|-----------|----|----|-------------
1|`id` | uuid | V |  | autogenerated
2|`persona_id` | uuid |  | [`verification_request_persona`](../tables/verification_request_persona.md) | Personal information. Relationship cardinality: 1-1
3|`education_id` | uuid |  | [`verification_request_education`](../tables/verification_request_education.md) | 
4|`validation_id` | uuid |  | [`verification_request_validations`](../tables/verification_request_validations.md) | Reference to the most recent validation
4|`employment_id` | uuid |  | [`verification_request_employment`](../tables/verification_request_employment.md) | 
5|`applicant_id` | uuid |  | [`applicants`](../tables/applicants.md) | The applicant that this VR belongs to
6|`employer_name` | varchar |  |  | The employer that issued the job offer
7|`occupation_id` | uuid |  | [`occupations`](../tables/occupations.md) | Occupation from the job offer
8|`joining_date` | date |  |  | Joining date from the job offer
9|`job_offer_file_id` | uuid |  | [`file_storage`](../tables/file_storage.md) | Job offer document
10|`service_provider_order_id` | varchar |  |  | In QVP V1 vrs were tied to a service provider id. This field is not used any more but it is migrated just in case.
11|`submitted_at` | timestamp |  |  | Time when VR was submitted for verification, the same time that the time when VR was paid for (payment.transaction_date)
11|`qvp_company_id` | uuid |  | [`qvp_companies`](../tables/qvp_companies.md) | 
12|`qvp_company_employee_id` | uuid |  | [`qvp_company_employees`](../tables/qvp_company_employees.md) | 
12|`vr_status` | varchar |  |  | One of: draft, unpaid, payment pending, paid, qualified, withdrawn, unqualified.
13|`report_file_id` | uuid |  | [`file_storage`](../tables/file_storage.md) | uuid - a file that contains a printable verification report
14|`consent_file_id` | uuid |  | [`file_storage`](../tables/file_storage.md) | A file (pdf) that contains text that the applicant agrees to the terms and conditions and applicant's name.
15|`is_consent_signed` | boolean |  |  | True is applicant checked consent checkbox
16|`document_number` | integer |  |  | User-friendly numeric document number that is used to identify the VR in emails, communications, printed documents. 
17|`document_id` | integer |  |  | User-readable id of the document
18|`assigned_at` | timestamp |  |  | Date and time when the vr was assigned to a specific verifier (employee) within the Service provider
19|`used_discount` | boolean |  |  | 
20|`received_at` | timestamp |  |  | Received (distributed to) by a Service provider company
21|`payment_details` | json |  |  | JSON describing payment totals as well as separate payments as an array
22|`fast_track_major_entity_record_id` | uuid |  | [`fast_track_major_entity_records`](../tables/fast_track_major_entity_records.md) | A reference to the entity that is on the fast track major entity list if a VR is based on the offer made by such company.
23|`other_major_entity_name` | varchar |  |  | 
24|`fast_track_immediate_record_id` | uuid |  | [`fast_track_immediate_records`](../tables/fast_track_immediate_records.md) | 
25|`verified_education_id` | uuid |  | [`verification_request_education`](../tables/verification_request_education.md) | An already verified eduсation that in certain cases can be attached to the VR
26|`eligibility_score_id` | uuid |  | [`verification_request_eligibility_scores`](../tables/verification_request_eligibility_scores.md) | A reference to a set of marks (or scores) that defines the eligibility score for this VR
27|`professional_certificate_id` | uuid |  | [`verification_request_professional_certificates`](../tables/verification_request_professional_certificates.md) | A professional certificate that is submitted for verification with the current VR.
28|`verified_professional_certificate_id` | uuid |  | [`verification_request_professional_certificates`](../tables/verification_request_professional_certificates.md) | An already verified professional certificate that can be attached to the vr in certain cases.
29|`education_form_filled_in` | boolean |  |  | Shows if verification_request_education is filled in
30|`professional_certificates_form_filled_in` | boolean |  |  | Shows if verification_request_candidate_professional_certificate is filled in
31|`qvp_version` | integer |  |  | not sure but I guess it distinguishes the requests from QVP v1 and QVP v2. Better to keep it
32|`ip_address_country_id` | uuid |  | [`countries`](../tables/countries.md) | There must be a validation based on ip, it is used for applying a VAT tax for a payment
33|`ip_address` | varchar |  |  | ip adress where the verification request was created.
34|`created_at` | timestamp |  |  | 
35|`updated_at` | timestamp |  |  | 
36|`deleted_status` | integer |  |  | 0 - active record, 1 - deleted record.

### svp_bookings ###

NO | NAME | DATA TYPE | PK | FK | DESCRIPTION            
---|------|-----------|----|----|-------------
1|`id` | uuid | V |  | Autoincr
2|`exam_result` | varchar |  |  | One of: PENDING, PASSED, FAILED
3|`cbt_exam_status` | varchar |  |  | One of: RESERVED, PENDING, COMPLETED, CANCELED, WITHDRAWN, PAYMENT_FAILED
4|`certificate_id` | uuid |  | [`svp_certificates`](../tables/svp_certificates.md) | Skill verification certificate, issued as a result of passing the exam
5|`applicant_id` | uuid |  | [`applicants`](../tables/applicants.md) | Applicant that booked an exam session
6|`exam_session_id` | uuid |  | [`exam_sessions`](../tables/exam_sessions.md) | An exam session that was booked
7|`payment_id` | uuid |  | [`payments`](../tables/payments.md) | TODO: Payment for the exam. Payments for qvp and svp should be united into one table. It's not yet ready
8|`cancellation_reason` | varchar |  |  | Description why the booking was cancelled. Free text, not an enum.
9|`is_paid` | boolean |  |  | A flag showing that the booking is paid either with credits or with a card payment
10|`keycode` | varchar |  |  | Prometric code
11|`cbt_eligibility_status` | varchar |  |  | When the exam is started, we send the Create Eligibility Request to Prometric, and Prometric returns -1 (failed) or 1 (success) as the response which we store in this column
12|`practical_eligibility_status` | varchar |  |  | When the exam is started, we send the Create Eligibility Request to Prometric, and Prometric returns -1 (failed) or 1 (success) as the response which we store in this column
13|`occupation_id` | uuid |  | [`occupations`](../tables/occupations.md) | The occupation that is going to be verified
14|`edit_reason` | varchar |  |  | Admins can update the bookings, if they update - the comment is required and stored in this field
15|`is_hidden` | boolean |  |  | When the reservation is created - it is by default is_hidden: true till payment is made Once User successfully made the payment - change to is_hidden: false In the System only is_hidden: false are shown
16|`practical_exam_status` | integer |  |  | One of: RESERVED, PENDING, COMPLETED, CANCELED, WITHDRAWN, PAYMENT_FAILED
17|`access_token` | varchar |  |  | Access token is a part of Reservation Ticket URL to attend the exam (randomly generated)
18|`cancelled_by_user_id` | uuid |  | [`users`](../tables/users.md) | The user that cancelled the booking
19|`cbt_started_at` | timestamp |  |  | 
20|`cbt_result_received_at` | timestamp |  |  | 
21|`practical_started_at` | timestamp |  |  | 
22|`practical_result_received_at` | timestamp |  |  | 
23|`cbt_prometric_outcome_response` | text |  |  | json
24|`practical_prometric_outcome_response` | text |  |  | json
25|`prometric_data` | text |  |  | json.Prometric data (or metadata) about exam
26|`created_at` | timestamp |  |  | 
27|`updated_at` | timestamp |  |  | 
28|`deleted_status` | varchar |  |  | ACTIVE, DELETED